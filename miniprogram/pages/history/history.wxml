<!--history.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-section">
    <view class="search-bar">
      <text class="search-icon">ğŸ”</text>
      <input class="search-input" 
             placeholder="æœç´¢å¤ç›˜è®°å½•..." 
             value="{{searchKeyword}}"
             bindinput="onSearchInput"
             bindconfirm="onSearch" />
      <button class="filter-btn" bindtap="onShowFilter">
        <text class="filter-icon">âš™ï¸</text>
      </button>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view class="filter-tags" wx:if="{{activeFilters.length > 0}}">
    <view class="filter-tag" wx:for="{{activeFilters}}" wx:key="*this">
      <text>{{item}}</text>
      <text class="remove-filter" bindtap="onRemoveFilter" data-filter="{{item}}">Ã—</text>
    </view>
    <button class="clear-filters" bindtap="onClearFilters">æ¸…é™¤å…¨éƒ¨</button>
  </view>

  <!-- æ—¶é—´ç­›é€‰ -->
  <view class="time-filter">
    <button class="time-btn {{timeFilter === 'all' ? 'active' : ''}}" 
            bindtap="onTimeFilter" data-filter="all">å…¨éƒ¨</button>
    <button class="time-btn {{timeFilter === 'week' ? 'active' : ''}}" 
            bindtap="onTimeFilter" data-filter="week">æœ¬å‘¨</button>
    <button class="time-btn {{timeFilter === 'month' ? 'active' : ''}}" 
            bindtap="onTimeFilter" data-filter="month">æœ¬æœˆ</button>
    <button class="time-btn {{timeFilter === 'quarter' ? 'active' : ''}}" 
            bindtap="onTimeFilter" data-filter="quarter">æœ¬å­£åº¦</button>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-bar">
    <text class="stats-text">å…±æ‰¾åˆ° {{filteredReviews.length}} æ¡è®°å½•</text>
    <button class="sort-btn" bindtap="onToggleSort">
      <text>{{sortOrder === 'desc' ? 'æœ€æ–°' : 'æœ€æ—§'}}ä¼˜å…ˆ</text>
      <text class="sort-icon">{{sortOrder === 'desc' ? 'â†“' : 'â†‘'}}</text>
    </button>
  </view>

  <!-- å¤ç›˜åˆ—è¡¨ -->
  <view class="reviews-list">
    <view class="review-item card fade-in" 
          wx:for="{{displayReviews}}" 
          wx:key="id"
          bindtap="onViewDetail"
          data-id="{{item.id}}">
      
      <!-- å¤ç›˜å¤´éƒ¨ -->
      <view class="review-header">
        <view class="review-title-section">
          <text class="review-title">{{item.title}}</text>
          <view class="review-meta">
            <text class="review-time">{{item.timeAgo}}</text>
            <text class="review-type">{{item.typeText}}</text>
          </view>
        </view>
        <view class="review-actions">
          <button class="action-btn" bindtap="onEditReview" data-id="{{item.id}}" catchtap="">
            <text class="action-icon">âœï¸</text>
          </button>
          <button class="action-btn" bindtap="onDeleteReview" data-id="{{item.id}}" catchtap="">
            <text class="action-icon">ğŸ—‘ï¸</text>
          </button>
        </view>
      </view>

      <!-- å¤ç›˜å†…å®¹é¢„è§ˆ -->
      <view class="review-content">
        <view class="content-section" wx:if="{{item.highlights}}">
          <text class="content-label">âœ¨ äº®ç‚¹ï¼š</text>
          <text class="content-preview">{{item.highlights}}</text>
        </view>
        <view class="content-section" wx:if="{{item.challenges}}">
          <text class="content-label">ğŸ¤” æŒ‘æˆ˜ï¼š</text>
          <text class="content-preview">{{item.challenges}}</text>
        </view>
        <view class="content-section" wx:if="{{item.learnings}}">
          <text class="content-label">ğŸ“š å­¦ä¹ ï¼š</text>
          <text class="content-preview">{{item.learnings}}</text>
        </view>
      </view>

      <!-- æ ‡ç­¾å’Œå¿ƒæƒ… -->
      <view class="review-footer">
        <view class="review-tags">
          <text class="tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
        </view>
        <view class="mood-indicator">
          <text class="mood-emoji">{{item.moodEmoji}}</text>
          <text class="mood-score">{{item.moodScore}}/5</text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore}}">
      <button class="load-more-btn" bindtap="onLoadMore" loading="{{loading}}">
        {{loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
      </button>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{displayReviews.length === 0 && !loading}}">
      <text class="empty-icon">ğŸ“</text>
      <text class="empty-text">{{searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å½•' : 'è¿˜æ²¡æœ‰å¤ç›˜è®°å½•'}}</text>
      <text class="empty-desc">{{searchKeyword ? 'è¯•è¯•å…¶ä»–å…³é”®è¯' : 'å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡å¤ç›˜å§'}}</text>
      <button class="btn-primary mt-20" bindtap="onCreateReview" wx:if="{{!searchKeyword}}">
        ç«‹å³å¼€å§‹
      </button>
    </view>
  </view>
</view>

<!-- ç­›é€‰å¼¹çª— -->
<view class="filter-modal {{showFilterModal ? 'active' : ''}}" bindtap="onCloseFilter">
  <view class="filter-modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">ç­›é€‰æ¡ä»¶</text>
      <button class="modal-close" bindtap="onCloseFilter">Ã—</button>
    </view>
    
    <view class="filter-content">
      <!-- å¤ç›˜ç±»å‹ç­›é€‰ -->
      <view class="filter-group">
        <text class="filter-group-title">å¤ç›˜ç±»å‹</text>
        <view class="filter-options">
          <button class="filter-option {{typeFilters.includes(item.value) ? 'active' : ''}}"
                  wx:for="{{reviewTypes}}" wx:key="value"
                  bindtap="onToggleTypeFilter" data-type="{{item.value}}">
            {{item.label}}
          </button>
        </view>
      </view>

      <!-- æ ‡ç­¾ç­›é€‰ -->
      <view class="filter-group">
        <text class="filter-group-title">æ ‡ç­¾</text>
        <view class="filter-options">
          <button class="filter-option {{tagFilters.includes(item) ? 'active' : ''}}"
                  wx:for="{{allTags}}" wx:key="*this"
                  bindtap="onToggleTagFilter" data-tag="{{item}}">
            {{item}}
          </button>
        </view>
      </view>

      <!-- å¿ƒæƒ…ç­›é€‰ -->
      <view class="filter-group">
        <text class="filter-group-title">å¿ƒæƒ…è¯„åˆ†</text>
        <view class="mood-filter">
          <button class="mood-option {{moodFilter === item.value ? 'active' : ''}}"
                  wx:for="{{moodOptions}}" wx:key="value"
                  bindtap="onMoodFilter" data-mood="{{item.value}}">
            <text class="mood-emoji">{{item.emoji}}</text>
            <text class="mood-text">{{item.label}}</text>
          </button>
        </view>
      </view>
    </view>

    <view class="filter-actions">
      <button class="filter-action-btn secondary" bindtap="onResetFilter">é‡ç½®</button>
      <button class="filter-action-btn primary" bindtap="onApplyFilter">åº”ç”¨ç­›é€‰</button>
    </view>
  </view>
</view>

